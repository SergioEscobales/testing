"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf3 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _kefir = _interopRequireDefault(require("kefir"));

var _kefirBus = _interopRequireDefault(require("kefir-bus"));

var _kefirStopper = _interopRequireDefault(require("kefir-stopper"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _pointRectDistance = _interopRequireDefault(require("./lib/pointRectDistance"));

var _MenuListInspector = _interopRequireDefault(require("./MenuListInspector"));

var _reactFloatAnchor = _interopRequireDefault(require("react-float-anchor"));

var _MenuItem = _interopRequireDefault(require("./MenuItem"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var SubMenuItem =
/*#__PURE__*/
function (_React$Component) {
  (0, _inherits2["default"])(SubMenuItem, _React$Component);

  function SubMenuItem() {
    var _getPrototypeOf2;

    var _this;

    (0, _classCallCheck2["default"])(this, SubMenuItem);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = (0, _possibleConstructorReturn2["default"])(this, (_getPrototypeOf2 = (0, _getPrototypeOf3["default"])(SubMenuItem)).call.apply(_getPrototypeOf2, [this].concat(args)));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      opened: false
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_menuItemRef", _react["default"].createRef());
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_floatAnchorRef", _react["default"].createRef());
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_menuInspectorRef", _react["default"].createRef());
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_menuContainerRef", _react["default"].createRef());
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_resetMouseLeaveWatcher", (0, _kefirBus["default"])());
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_stopper", (0, _kefirStopper["default"])());
    return _this;
  }

  (0, _createClass2["default"])(SubMenuItem, [{
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      this._stopper.destroy();
    }
  }, {
    key: "open",
    value: function open() {
      var _this2 = this;

      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();
      menuItem.lockHighlight();
      if (this.state.opened) return Promise.resolve();
      if (this.props.onWillOpen) this.props.onWillOpen();
      menuItem.takeKeyboard();
      return new Promise(function (resolve) {
        _this2.setState({
          opened: true
        }, function () {
          if (_this2.props.onDidOpen) _this2.props.onDidOpen();
          resolve();
        });
      });
    }
  }, {
    key: "close",
    value: function close() {
      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();
      if (!this.state.opened) return;
      if (this.props.onWillClose) this.props.onWillClose();
      this.setState({
        opened: false
      });
      menuItem.releaseKeyboard();
      menuItem.unlockHighlight();
    }
  }, {
    key: "toggle",
    value: function toggle() {
      if (this.state.opened) {
        this.close();
      } else {
        this.open();
      }
    }
  }, {
    key: "reposition",
    value: function reposition() {
      var floatAnchor = this._floatAnchorRef.current;
      if (!floatAnchor) throw new Error();
      floatAnchor.reposition();
    }
  }, {
    key: "hasHighlight",
    value: function hasHighlight() {
      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();
      return menuItem.hasHighlight();
    }
  }, {
    key: "highlight",
    value: function highlight() {
      var byKeyboard = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();
      menuItem.highlight(byKeyboard);
    }
  }, {
    key: "unhighlight",
    value: function unhighlight() {
      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();
      menuItem.unhighlight();
    }
  }, {
    key: "moveCursor",
    value: function moveCursor(direction, prevCursorLocation) {
      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();
      menuItem.moveCursor(direction, prevCursorLocation);
    }
  }, {
    key: "_onHighlightChange",
    value: function _onHighlightChange(highlighted, event) {
      var _this3 = this;

      this._resetMouseLeaveWatcher.emit(null);

      if (highlighted && !event.byKeyboard) {
        var OPEN_DELAY = 200;

        _kefir["default"].later(OPEN_DELAY).takeUntilBy(this._resetMouseLeaveWatcher).takeUntilBy(this._stopper).onValue(function () {
          _this3.open();
        });
      } else if (!highlighted) {
        this.close();
      }
    }
  }, {
    key: "_onMouseLeaveItem",
    value: function _onMouseLeaveItem(event) {
      var _this4 = this;

      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();

      if (!this.state.opened) {
        menuItem.unhighlight();
        return;
      }

      var menuContainer = this._menuContainerRef.current;
      if (!menuContainer) throw new Error(); // If the mouse isn't going toward the menu, then unhighlight ourself.

      var menuRect = menuContainer.getBoundingClientRect();
      var startTime = Date.now();
      var startX = event.pageX,
          startY = event.pageY;

      function getDistance(x, y) {
        return (0, _pointRectDistance["default"])(x, y, menuRect.left, menuRect.top, menuRect.right - menuRect.width, menuRect.bottom - menuRect.top);
      }

      var startDistance = getDistance(startX, startY);
      var lastCoords = {
        pageX: startX,
        pageY: startY
      }; // pixels per second the user must be moving the mouse toward the menu for
      // the menu to stay open.

      var MIN_SPEED = 60; // ms before the menu will close if the user hasn't reached it yet, no
      // matter how they're moving the cursor toward it.

      var MAX_TIME = 750; // ms to offset start time, to set maxDistance back a little so it's not so
      // unforgiving at the very start.

      var LEAD_TIME = 50; // Listen to mouse moves, find the first event not going towards the menu,
      // and end it there. Or end after a timer.

      _kefir["default"].fromEvents(window, 'mousemove').bufferBy(_kefir["default"].interval(60, null)).map(function (events) {
        if (events.length) {
          var last = events[events.length - 1];
          lastCoords = {
            pageX: last.pageX,
            pageY: last.pageY
          };
        }

        return lastCoords;
      }).filter(function (_ref) {
        var pageX = _ref.pageX,
            pageY = _ref.pageY;
        var distance = getDistance(pageX, pageY);
        var maxDistance = startDistance - (Date.now() - startTime - LEAD_TIME) / 1000 * MIN_SPEED;
        return distance > maxDistance;
      }).merge(_kefir["default"].later(MAX_TIME * 1000)).take(1).takeUntilBy(this._resetMouseLeaveWatcher).takeUntilBy(this._stopper).onValue(function () {
        _this4.close();

        menuItem.unhighlight();
      });
    }
  }, {
    key: "_mouseEnterMenu",
    value: function _mouseEnterMenu() {
      var menuItem = this._menuItemRef.current;
      if (!menuItem) throw new Error();

      this._resetMouseLeaveWatcher.emit(null);

      menuItem.unlockHighlight();
    }
  }, {
    key: "render",
    value: function render() {
      var _this5 = this;

      var _this$props = this.props,
          index = _this$props.index,
          highlightedStyle = _this$props.highlightedStyle,
          highlightedClassName = _this$props.highlightedClassName,
          positionOptions = _this$props.positionOptions,
          menuZIndex = _this$props.menuZIndex,
          children = _this$props.children,
          menu = _this$props.menu;
      var opened = this.state.opened;
      var style = this.props.style;
      var className = this.props.className;

      if (opened) {
        if (this.props.openedStyle) {
          style = _objectSpread({}, style, {}, this.props.openedStyle);
        }

        if (this.props.openedClassName) {
          className = "".concat(className || '', " ").concat(this.props.openedClassName);
        }
      }

      return _react["default"].createElement(_reactFloatAnchor["default"], {
        parentElement: this.props.menuParentElement,
        ref: this._floatAnchorRef,
        options: positionOptions,
        zIndex: menuZIndex,
        anchor: function anchor(anchorRef) {
          return _react["default"].createElement(_MenuItem["default"], {
            ref: _this5._menuItemRef,
            domRef: anchorRef,
            index: index,
            style: style,
            className: className,
            highlightedStyle: highlightedStyle,
            highlightedClassName: highlightedClassName,
            onHighlightChange: function onHighlightChange(h, e) {
              return _this5._onHighlightChange(h, e);
            },
            onMouseLeave: function onMouseLeave(e) {
              return _this5._onMouseLeaveItem(e);
            },
            onRightPushed: function onRightPushed(e) {
              if (!_this5.state.opened) {
                e.stopPropagation();
                e.preventDefault();

                _this5.open();

                var menuInspector = _this5._menuInspectorRef.current;
                if (!menuInspector) throw new Error();
                menuInspector.moveCursor('down');
              }
            },
            onItemChosen: function onItemChosen(e) {
              e.stopPropagation();
              e.preventDefault();

              _this5.open();

              if (e.byKeyboard) {
                var menuInspector = _this5._menuInspectorRef.current;
                if (!menuInspector) throw new Error();
                menuInspector.moveCursor('down');
              }
            },
            "aria-haspopup": true,
            "aria-expanded": opened
          }, children);
        },
        "float": !opened ? null : _react["default"].createElement(_MenuListInspector["default"], {
          ref: this._menuInspectorRef,
          onLeftPushed: function onLeftPushed(e) {
            e.stopPropagation();
            e.preventDefault();

            _this5.close();
          }
        }, _react["default"].createElement("div", {
          ref: this._menuContainerRef,
          onMouseEnter: function onMouseEnter() {
            return _this5._mouseEnterMenu();
          }
        }, menu))
      });
    }
  }]);
  return SubMenuItem;
}(_react["default"].Component);

exports["default"] = SubMenuItem;
(0, _defineProperty2["default"])(SubMenuItem, "propTypes", {
  menu: _propTypes["default"].node,
  positionOptions: _propTypes["default"].object,
  menuZIndex: _propTypes["default"].oneOfType([_propTypes["default"].string, _propTypes["default"].number]),
  onWillOpen: _propTypes["default"].func,
  onDidOpen: _propTypes["default"].func,
  onWillClose: _propTypes["default"].func,
  className: _propTypes["default"].string,
  style: _propTypes["default"].object,
  highlightedClassName: _propTypes["default"].string,
  highlightedStyle: _propTypes["default"].object,
  index: _propTypes["default"].number,
  openedClassName: _propTypes["default"].string,
  openedStyle: _propTypes["default"].object,
  onItemChosen: _propTypes["default"].func,
  onHighlightChange: _propTypes["default"].func,
  children: _propTypes["default"].node
});
(0, _defineProperty2["default"])(SubMenuItem, "defaultProps", {
  positionOptions: {
    position: 'right',
    vAlign: 'top',
    hAlign: 'left'
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdWJNZW51SXRlbS5qcyJdLCJuYW1lcyI6WyJTdWJNZW51SXRlbSIsIm9wZW5lZCIsIlJlYWN0IiwiY3JlYXRlUmVmIiwiX3N0b3BwZXIiLCJkZXN0cm95IiwibWVudUl0ZW0iLCJfbWVudUl0ZW1SZWYiLCJjdXJyZW50IiwiRXJyb3IiLCJsb2NrSGlnaGxpZ2h0Iiwic3RhdGUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInByb3BzIiwib25XaWxsT3BlbiIsInRha2VLZXlib2FyZCIsInNldFN0YXRlIiwib25EaWRPcGVuIiwib25XaWxsQ2xvc2UiLCJyZWxlYXNlS2V5Ym9hcmQiLCJ1bmxvY2tIaWdobGlnaHQiLCJjbG9zZSIsIm9wZW4iLCJmbG9hdEFuY2hvciIsIl9mbG9hdEFuY2hvclJlZiIsInJlcG9zaXRpb24iLCJoYXNIaWdobGlnaHQiLCJieUtleWJvYXJkIiwiaGlnaGxpZ2h0IiwidW5oaWdobGlnaHQiLCJkaXJlY3Rpb24iLCJwcmV2Q3Vyc29yTG9jYXRpb24iLCJtb3ZlQ3Vyc29yIiwiaGlnaGxpZ2h0ZWQiLCJldmVudCIsIl9yZXNldE1vdXNlTGVhdmVXYXRjaGVyIiwiZW1pdCIsIk9QRU5fREVMQVkiLCJLZWZpciIsImxhdGVyIiwidGFrZVVudGlsQnkiLCJvblZhbHVlIiwibWVudUNvbnRhaW5lciIsIl9tZW51Q29udGFpbmVyUmVmIiwibWVudVJlY3QiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJzdGFydFRpbWUiLCJEYXRlIiwibm93Iiwic3RhcnRYIiwicGFnZVgiLCJzdGFydFkiLCJwYWdlWSIsImdldERpc3RhbmNlIiwieCIsInkiLCJsZWZ0IiwidG9wIiwicmlnaHQiLCJ3aWR0aCIsImJvdHRvbSIsInN0YXJ0RGlzdGFuY2UiLCJsYXN0Q29vcmRzIiwiTUlOX1NQRUVEIiwiTUFYX1RJTUUiLCJMRUFEX1RJTUUiLCJmcm9tRXZlbnRzIiwid2luZG93IiwiYnVmZmVyQnkiLCJpbnRlcnZhbCIsIm1hcCIsImV2ZW50cyIsImxlbmd0aCIsImxhc3QiLCJmaWx0ZXIiLCJkaXN0YW5jZSIsIm1heERpc3RhbmNlIiwibWVyZ2UiLCJ0YWtlIiwiaW5kZXgiLCJoaWdobGlnaHRlZFN0eWxlIiwiaGlnaGxpZ2h0ZWRDbGFzc05hbWUiLCJwb3NpdGlvbk9wdGlvbnMiLCJtZW51WkluZGV4IiwiY2hpbGRyZW4iLCJtZW51Iiwic3R5bGUiLCJjbGFzc05hbWUiLCJvcGVuZWRTdHlsZSIsIm9wZW5lZENsYXNzTmFtZSIsIm1lbnVQYXJlbnRFbGVtZW50IiwiYW5jaG9yUmVmIiwiaCIsImUiLCJfb25IaWdobGlnaHRDaGFuZ2UiLCJfb25Nb3VzZUxlYXZlSXRlbSIsInN0b3BQcm9wYWdhdGlvbiIsInByZXZlbnREZWZhdWx0IiwibWVudUluc3BlY3RvciIsIl9tZW51SW5zcGVjdG9yUmVmIiwiX21vdXNlRW50ZXJNZW51IiwiQ29tcG9uZW50IiwiUHJvcFR5cGVzIiwibm9kZSIsIm9iamVjdCIsIm9uZU9mVHlwZSIsInN0cmluZyIsIm51bWJlciIsImZ1bmMiLCJvbkl0ZW1DaG9zZW4iLCJvbkhpZ2hsaWdodENoYW5nZSIsInBvc2l0aW9uIiwidkFsaWduIiwiaEFsaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUdBOzs7Ozs7SUFtQ3FCQSxXOzs7Ozs7Ozs7Ozs7Ozs7Ozs4RkE2Qko7QUFDYkMsTUFBQUEsTUFBTSxFQUFFO0FBREssSztxR0FJQUMsa0JBQU1DLFNBQU4sRTt3R0FDR0Qsa0JBQU1DLFNBQU4sRTswR0FDRUQsa0JBQU1DLFNBQU4sRTswR0FDQUQsa0JBQU1DLFNBQU4sRTtnSEFDaUIsMkI7aUdBQzFCLCtCOzs7Ozs7MkNBRVk7QUFDckIsV0FBS0MsUUFBTCxDQUFjQyxPQUFkO0FBQ0Q7OzsyQkFFcUI7QUFBQTs7QUFDcEIsVUFBTUMsUUFBUSxHQUFHLEtBQUtDLFlBQUwsQ0FBa0JDLE9BQW5DO0FBQ0EsVUFB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REF4RyxXLGtCQXlCRztBQUNwQm1GLEVBQUFBLGVBQWUsRUFBRTtBQUFDNkIsSUFBQUEsUUFBUSxFQUFDLE9BQVY7QUFBbUJDLElBQUFBLE1BQU0sRUFBQyxLQUExQjtBQUFpQ0MsSUFBQUEsTUFBTSxFQUFFO0FBQXpDO0FBREcsQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbmltcG9ydCBLZWZpciBmcm9tICdrZWZpcic7XG5pbXBvcnQga2VmaXJCdXMgZnJvbSAna2VmaXItYnVzJztcbmltcG9ydCB0eXBlIHtCdXN9IGZyb20gJ2tlZmlyLWJ1cyc7XG5pbXBvcnQga2VmaXJTdG9wcGVyIGZyb20gJ2tlZmlyLXN0b3BwZXInO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB0eXBlIHtOb2RlIGFzIFJlYWN0Tm9kZX0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBwb2ludFJlY3REaXN0YW5jZSBmcm9tICcuL2xpYi9wb2ludFJlY3REaXN0YW5jZSc7XG5cbmltcG9ydCBNZW51TGlzdEluc3BlY3RvciBmcm9tICcuL01lbnVMaXN0SW5zcGVjdG9yJztcbmltcG9ydCBGbG9hdEFuY2hvciBmcm9tICdyZWFjdC1mbG9hdC1hbmNob3InO1xuaW1wb3J0IHR5cGUge09wdGlvbnMgYXMgRmxvYXRBbmNob3JPcHRpb25zfSBmcm9tICdyZWFjdC1mbG9hdC1hbmNob3InO1xuZXhwb3J0IHR5cGUge09wdGlvbnMgYXMgRmxvYXRBbmNob3JPcHRpb25zfSBmcm9tICdyZWFjdC1mbG9hdC1hbmNob3InO1xuaW1wb3J0IE1lbnVJdGVtIGZyb20gJy4vTWVudUl0ZW0nO1xuXG5pbXBvcnQgdHlwZSB7RGlyZWN0aW9uLCBSZWN0fSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB0eXBlIE1lbnVFdmVudCBmcm9tICcuL2V2ZW50cy9NZW51RXZlbnQnO1xuaW1wb3J0IHR5cGUgQ2hvc2VuRXZlbnQgZnJvbSAnLi9ldmVudHMvQ2hvc2VuRXZlbnQnO1xuXG50eXBlIFN0YXRlID0ge1xuICBvcGVuZWQ6IGJvb2xlYW47XG59O1xuXG5leHBvcnQgdHlwZSBQcm9wcyA9IHtcbiAgbWVudTogUmVhY3ROb2RlO1xuICBwb3NpdGlvbk9wdGlvbnM6IEZsb2F0QW5jaG9yT3B0aW9ucztcbiAgbWVudVpJbmRleD86IHN0cmluZ3xudW1iZXI7XG4gIG1lbnVQYXJlbnRFbGVtZW50PzogSFRNTEVsZW1lbnQ7XG5cbiAgb25XaWxsT3Blbj86ICgpID0+IHZvaWQ7XG4gIG9uRGlkT3Blbj86ICgpID0+IHZvaWQ7XG4gIG9uV2lsbENsb3NlPzogKCkgPT4gdm9pZDtcblxuICBjbGFzc05hbWU/OiBzdHJpbmc7XG4gIHN0eWxlPzogT2JqZWN0O1xuICBoaWdobGlnaHRlZENsYXNzTmFtZT86IHN0cmluZztcbiAgaGlnaGxpZ2h0ZWRTdHlsZT86IE9iamVjdDtcbiAgaW5kZXg/OiBudW1iZXI7XG5cbiAgb3BlbmVkQ2xhc3NOYW1lPzogc3RyaW5nO1xuICBvcGVuZWRTdHlsZT86IE9iamVjdDtcblxuICBvbkl0ZW1DaG9zZW4/OiAoZXZlbnQ6IENob3NlbkV2ZW50KSA9PiB2b2lkO1xuICBvbkhpZ2hsaWdodENoYW5nZT86IChoaWdobGlnaHRlZDogYm9vbGVhbiwgZGV0YWlsczoge2J5S2V5Ym9hcmQ/OiBib29sZWFuLCBwcmV2Q3Vyc29yTG9jYXRpb24/OiBSZWN0LCBkaXJlY3Rpb24/OiBEaXJlY3Rpb259KSA9PiB2b2lkO1xuXG4gIGNoaWxkcmVuPzogUmVhY3ROb2RlO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3ViTWVudUl0ZW0gZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgbWVudTogUHJvcFR5cGVzLm5vZGUsXG4gICAgcG9zaXRpb25PcHRpb25zOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIG1lbnVaSW5kZXg6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5zdHJpbmcsIFByb3BUeXBlcy5udW1iZXJdKSxcblxuICAgIG9uV2lsbE9wZW46IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uRGlkT3BlbjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25XaWxsQ2xvc2U6IFByb3BUeXBlcy5mdW5jLFxuXG4gICAgY2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIHN0eWxlOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIGhpZ2hsaWdodGVkQ2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGhpZ2hsaWdodGVkU3R5bGU6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgaW5kZXg6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgICBvcGVuZWRDbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgb3BlbmVkU3R5bGU6IFByb3BUeXBlcy5vYmplY3QsXG5cbiAgICBvbkl0ZW1DaG9zZW46IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uSGlnaGxpZ2h0Q2hhbmdlOiBQcm9wVHlwZXMuZnVuYyxcblxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMubm9kZVxuICB9O1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgcG9zaXRpb25PcHRpb25zOiB7cG9zaXRpb246J3JpZ2h0JywgdkFsaWduOid0b3AnLCBoQWxpZ246ICdsZWZ0J31cbiAgfTtcblxuICBzdGF0ZTogU3RhdGUgPSB7XG4gICAgb3BlbmVkOiBmYWxzZVxuICB9O1xuXG4gIF9tZW51SXRlbVJlZiA9IFJlYWN0LmNyZWF0ZVJlZjxNZW51SXRlbT4oKTtcbiAgX2Zsb2F0QW5jaG9yUmVmID0gUmVhY3QuY3JlYXRlUmVmPEZsb2F0QW5jaG9yPigpO1xuICBfbWVudUluc3BlY3RvclJlZiA9IFJlYWN0LmNyZWF0ZVJlZjxNZW51TGlzdEluc3BlY3Rvcj4oKTtcbiAgX21lbnVDb250YWluZXJSZWYgPSBSZWFjdC5jcmVhdGVSZWY8SFRNTERpdkVsZW1lbnQ+KCk7XG4gIF9yZXNldE1vdXNlTGVhdmVXYXRjaGVyOiBCdXM8bnVsbD4gPSBrZWZpckJ1cygpO1xuICBfc3RvcHBlciA9IGtlZmlyU3RvcHBlcigpO1xuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHRoaXMuX3N0b3BwZXIuZGVzdHJveSgpO1xuICB9XG5cbiAgb3BlbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBtZW51SXRlbSA9IHRoaXMuX21lbnVJdGVtUmVmLmN1cnJlbnQ7XG4gICAgaWYgKCFtZW51SXRlbSkgdGhyb3cgbmV3IEVycm9yKCk7XG5cbiAgICBtZW51SXRlbS5sb2NrSGlnaGxpZ2h0KCk7XG4gICAgaWYgKHRoaXMuc3RhdGUub3BlbmVkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgaWYgKHRoaXMucHJvcHMub25XaWxsT3BlbikgdGhpcy5wcm9wcy5vbldpbGxPcGVuKCk7XG4gICAgbWVudUl0ZW0udGFrZUtleWJvYXJkKCk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7b3BlbmVkOiB0cnVlfSwgKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5vbkRpZE9wZW4pIHRoaXMucHJvcHMub25EaWRPcGVuKCk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgY2xvc2UoKSB7XG4gICAgY29uc3QgbWVudUl0ZW0gPSB0aGlzLl9tZW51SXRlbVJlZi5jdXJyZW50O1xuICAgIGlmICghbWVudUl0ZW0pIHRocm93IG5ldyBFcnJvcigpO1xuXG4gICAgaWYgKCF0aGlzLnN0YXRlLm9wZW5lZCkgcmV0dXJuO1xuICAgIGlmICh0aGlzLnByb3BzLm9uV2lsbENsb3NlKSB0aGlzLnByb3BzLm9uV2lsbENsb3NlKCk7XG4gICAgdGhpcy5zZXRTdGF0ZSh7b3BlbmVkOiBmYWxzZX0pO1xuICAgIG1lbnVJdGVtLnJlbGVhc2VLZXlib2FyZCgpO1xuICAgIG1lbnVJdGVtLnVubG9ja0hpZ2hsaWdodCgpO1xuICB9XG5cbiAgdG9nZ2xlKCkge1xuICAgIGlmICh0aGlzLnN0YXRlLm9wZW5lZCkge1xuICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wZW4oKTtcbiAgICB9XG4gIH1cblxuICByZXBvc2l0aW9uKCkge1xuICAgIGNvbnN0IGZsb2F0QW5jaG9yID0gdGhpcy5fZmxvYXRBbmNob3JSZWYuY3VycmVudDtcbiAgICBpZiAoIWZsb2F0QW5jaG9yKSB0aHJvdyBuZXcgRXJyb3IoKTtcblxuICAgIGZsb2F0QW5jaG9yLnJlcG9zaXRpb24oKTtcbiAgfVxuXG4gIGhhc0hpZ2hsaWdodCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBtZW51SXRlbSA9IHRoaXMuX21lbnVJdGVtUmVmLmN1cnJlbnQ7XG4gICAgaWYgKCFtZW51SXRlbSkgdGhyb3cgbmV3IEVycm9yKCk7XG5cbiAgICByZXR1cm4gbWVudUl0ZW0uaGFzSGlnaGxpZ2h0KCk7XG4gIH1cblxuICBoaWdobGlnaHQoYnlLZXlib2FyZDogYm9vbGVhbj10cnVlKSB7XG4gICAgY29uc3QgbWVudUl0ZW0gPSB0aGlzLl9tZW51SXRlbVJlZi5jdXJyZW50O1xuICAgIGlmICghbWVudUl0ZW0pIHRocm93IG5ldyBFcnJvcigpO1xuXG4gICAgbWVudUl0ZW0uaGlnaGxpZ2h0KGJ5S2V5Ym9hcmQpO1xuICB9XG5cbiAgdW5oaWdobGlnaHQoKSB7XG4gICAgY29uc3QgbWVudUl0ZW0gPSB0aGlzLl9tZW51SXRlbVJlZi5jdXJyZW50O1xuICAgIGlmICghbWVudUl0ZW0pIHRocm93IG5ldyBFcnJvcigpO1xuXG4gICAgbWVudUl0ZW0udW5oaWdobGlnaHQoKTtcbiAgfVxuXG4gIG1vdmVDdXJzb3IoZGlyZWN0aW9uOiBEaXJlY3Rpb24sIHByZXZDdXJzb3JMb2NhdGlvbjogP1JlY3QpIHtcbiAgICBjb25zdCBtZW51SXRlbSA9IHRoaXMuX21lbnVJdGVtUmVmLmN1cnJlbnQ7XG4gICAgaWYgKCFtZW51SXRlbSkgdGhyb3cgbmV3IEVycm9yKCk7XG5cbiAgICBtZW51SXRlbS5tb3ZlQ3Vyc29yKGRpcmVjdGlvbiwgcHJldkN1cnNvckxvY2F0aW9uKTtcbiAgfVxuXG4gIF9vbkhpZ2hsaWdodENoYW5nZShoaWdobGlnaHRlZDogYm9vbGVhbiwgZXZlbnQ6IE9iamVjdCkge1xuICAgIHRoaXMuX3Jlc2V0TW91c2VMZWF2ZVdhdGNoZXIuZW1pdChudWxsKTtcblxuICAgIGlmIChoaWdobGlnaHRlZCAmJiAhZXZlbnQuYnlLZXlib2FyZCkge1xuICAgICAgY29uc3QgT1BFTl9ERUxBWSA9IDIwMDtcblxuICAgICAgS2VmaXIubGF0ZXIoT1BFTl9ERUxBWSlcbiAgICAgICAgLnRha2VVbnRpbEJ5KHRoaXMuX3Jlc2V0TW91c2VMZWF2ZVdhdGNoZXIpXG4gICAgICAgIC50YWtlVW50aWxCeSh0aGlzLl9zdG9wcGVyKVxuICAgICAgICAub25WYWx1ZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5vcGVuKCk7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoIWhpZ2hsaWdodGVkKSB7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgX29uTW91c2VMZWF2ZUl0ZW0oZXZlbnQ6IE9iamVjdCkge1xuICAgIGNvbnN0IG1lbnVJdGVtID0gdGhpcy5fbWVudUl0ZW1SZWYuY3VycmVudDtcbiAgICBpZiAoIW1lbnVJdGVtKSB0aHJvdyBuZXcgRXJyb3IoKTtcblxuICAgIGlmICghdGhpcy5zdGF0ZS5vcGVuZWQpIHtcbiAgICAgIG1lbnVJdGVtLnVuaGlnaGxpZ2h0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbWVudUNvbnRhaW5lciA9IHRoaXMuX21lbnVDb250YWluZXJSZWYuY3VycmVudDtcbiAgICBpZiAoIW1lbnVDb250YWluZXIpIHRocm93IG5ldyBFcnJvcigpO1xuXG4gICAgLy8gSWYgdGhlIG1vdXNlIGlzbid0IGdvaW5nIHRvd2FyZCB0aGUgbWVudSwgdGhlbiB1bmhpZ2hsaWdodCBvdXJzZWxmLlxuXG4gICAgY29uc3QgbWVudVJlY3QgPSBtZW51Q29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBzdGFydFggPSBldmVudC5wYWdlWCwgc3RhcnRZID0gZXZlbnQucGFnZVk7XG5cbiAgICBmdW5jdGlvbiBnZXREaXN0YW5jZSh4LCB5KSB7XG4gICAgICByZXR1cm4gcG9pbnRSZWN0RGlzdGFuY2UoeCwgeSwgbWVudVJlY3QubGVmdCwgbWVudVJlY3QudG9wLCBtZW51UmVjdC5yaWdodC1tZW51UmVjdC53aWR0aCwgbWVudVJlY3QuYm90dG9tLW1lbnVSZWN0LnRvcCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnREaXN0YW5jZSA9IGdldERpc3RhbmNlKHN0YXJ0WCwgc3RhcnRZKTtcbiAgICBsZXQgbGFzdENvb3JkcyA9IHtwYWdlWDogc3RhcnRYLCBwYWdlWTogc3RhcnRZfTtcblxuICAgIC8vIHBpeGVscyBwZXIgc2Vjb25kIHRoZSB1c2VyIG11c3QgYmUgbW92aW5nIHRoZSBtb3VzZSB0b3dhcmQgdGhlIG1lbnUgZm9yXG4gICAgLy8gdGhlIG1lbnUgdG8gc3RheSBvcGVuLlxuICAgIGNvbnN0IE1JTl9TUEVFRCA9IDYwO1xuXG4gICAgLy8gbXMgYmVmb3JlIHRoZSBtZW51IHdpbGwgY2xvc2UgaWYgdGhlIHVzZXIgaGFzbid0IHJlYWNoZWQgaXQgeWV0LCBub1xuICAgIC8vIG1hdHRlciBob3cgdGhleSdyZSBtb3ZpbmcgdGhlIGN1cnNvciB0b3dhcmQgaXQuXG4gICAgY29uc3QgTUFYX1RJTUUgPSA3NTA7XG5cbiAgICAvLyBtcyB0byBvZmZzZXQgc3RhcnQgdGltZSwgdG8gc2V0IG1heERpc3RhbmNlIGJhY2sgYSBsaXR0bGUgc28gaXQncyBub3Qgc29cbiAgICAvLyB1bmZvcmdpdmluZyBhdCB0aGUgdmVyeSBzdGFydC5cbiAgICBjb25zdCBMRUFEX1RJTUUgPSA1MDtcblxuICAgIC8vIExpc3RlbiB0byBtb3VzZSBtb3ZlcywgZmluZCB0aGUgZmlyc3QgZXZlbnQgbm90IGdvaW5nIHRvd2FyZHMgdGhlIG1lbnUsXG4gICAgLy8gYW5kIGVuZCBpdCB0aGVyZS4gT3IgZW5kIGFmdGVyIGEgdGltZXIuXG4gICAgS2VmaXIuZnJvbUV2ZW50cyh3aW5kb3csICdtb3VzZW1vdmUnKVxuICAgICAgLmJ1ZmZlckJ5KEtlZmlyLmludGVydmFsKDYwLCBudWxsKSlcbiAgICAgIC5tYXAoZXZlbnRzID0+IHtcbiAgICAgICAgaWYgKGV2ZW50cy5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCBsYXN0ID0gZXZlbnRzW2V2ZW50cy5sZW5ndGgtMV07XG4gICAgICAgICAgbGFzdENvb3JkcyA9IHtwYWdlWDogbGFzdC5wYWdlWCwgcGFnZVk6IGxhc3QucGFnZVl9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsYXN0Q29vcmRzO1xuICAgICAgfSlcbiAgICAgIC5maWx0ZXIoKHtwYWdlWCwgcGFnZVl9KSA9PiB7XG4gICAgICAgIGNvbnN0IGRpc3RhbmNlID0gZ2V0RGlzdGFuY2UocGFnZVgsIHBhZ2VZKTtcbiAgICAgICAgY29uc3QgbWF4RGlzdGFuY2UgPSBzdGFydERpc3RhbmNlIC0gKERhdGUubm93KCktc3RhcnRUaW1lLUxFQURfVElNRSkvMTAwMCAqIE1JTl9TUEVFRDtcbiAgICAgICAgcmV0dXJuIGRpc3RhbmNlID4gbWF4RGlzdGFuY2U7XG4gICAgICB9KVxuICAgICAgLm1lcmdlKEtlZmlyLmxhdGVyKE1BWF9USU1FKjEwMDApKVxuICAgICAgLnRha2UoMSlcbiAgICAgIC50YWtlVW50aWxCeSh0aGlzLl9yZXNldE1vdXNlTGVhdmVXYXRjaGVyKVxuICAgICAgLnRha2VVbnRpbEJ5KHRoaXMuX3N0b3BwZXIpXG4gICAgICAub25WYWx1ZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgbWVudUl0ZW0udW5oaWdobGlnaHQoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgX21vdXNlRW50ZXJNZW51KCkge1xuICAgIGNvbnN0IG1lbnVJdGVtID0gdGhpcy5fbWVudUl0ZW1SZWYuY3VycmVudDtcbiAgICBpZiAoIW1lbnVJdGVtKSB0aHJvdyBuZXcgRXJyb3IoKTtcblxuICAgIHRoaXMuX3Jlc2V0TW91c2VMZWF2ZVdhdGNoZXIuZW1pdChudWxsKTtcbiAgICBtZW51SXRlbS51bmxvY2tIaWdobGlnaHQoKTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBpbmRleCwgaGlnaGxpZ2h0ZWRTdHlsZSwgaGlnaGxpZ2h0ZWRDbGFzc05hbWUsXG4gICAgICBwb3NpdGlvbk9wdGlvbnMsIG1lbnVaSW5kZXgsIGNoaWxkcmVuLCBtZW51XG4gICAgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3Qge29wZW5lZH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgbGV0IHN0eWxlID0gdGhpcy5wcm9wcy5zdHlsZTtcbiAgICBsZXQgY2xhc3NOYW1lID0gdGhpcy5wcm9wcy5jbGFzc05hbWU7XG4gICAgaWYgKG9wZW5lZCkge1xuICAgICAgaWYgKHRoaXMucHJvcHMub3BlbmVkU3R5bGUpIHtcbiAgICAgICAgc3R5bGUgPSB7Li4uc3R5bGUsIC4uLnRoaXMucHJvcHMub3BlbmVkU3R5bGV9O1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMucHJvcHMub3BlbmVkQ2xhc3NOYW1lKSB7XG4gICAgICAgIGNsYXNzTmFtZSA9IGAke2NsYXNzTmFtZXx8Jyd9ICR7dGhpcy5wcm9wcy5vcGVuZWRDbGFzc05hbWV9YDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gKFxuICAgICAgPEZsb2F0QW5jaG9yXG4gICAgICAgIHBhcmVudEVsZW1lbnQ9e3RoaXMucHJvcHMubWVudVBhcmVudEVsZW1lbnR9XG4gICAgICAgIHJlZj17dGhpcy5fZmxvYXRBbmNob3JSZWZ9XG4gICAgICAgIG9wdGlvbnM9e3Bvc2l0aW9uT3B0aW9uc31cbiAgICAgICAgekluZGV4PXttZW51WkluZGV4fVxuICAgICAgICBhbmNob3I9e2FuY2hvclJlZiA9PlxuICAgICAgICAgIDxNZW51SXRlbVxuICAgICAgICAgICAgcmVmPXt0aGlzLl9tZW51SXRlbVJlZn1cbiAgICAgICAgICAgIGRvbVJlZj17YW5jaG9yUmVmfVxuICAgICAgICAgICAgaW5kZXg9e2luZGV4fVxuICAgICAgICAgICAgc3R5bGU9e3N0eWxlfVxuICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWV9XG4gICAgICAgICAgICBoaWdobGlnaHRlZFN0eWxlPXtoaWdobGlnaHRlZFN0eWxlfVxuICAgICAgICAgICAgaGlnaGxpZ2h0ZWRDbGFzc05hbWU9e2hpZ2hsaWdodGVkQ2xhc3NOYW1lfVxuICAgICAgICAgICAgb25IaWdobGlnaHRDaGFuZ2U9eyhoLGUpID0+IHRoaXMuX29uSGlnaGxpZ2h0Q2hhbmdlKGgsZSl9XG4gICAgICAgICAgICBvbk1vdXNlTGVhdmU9e2UgPT4gdGhpcy5fb25Nb3VzZUxlYXZlSXRlbShlKX1cbiAgICAgICAgICAgIG9uUmlnaHRQdXNoZWQ9eyhlOiBNZW51RXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLm9wZW5lZCkge1xuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHRoaXMub3BlbigpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1lbnVJbnNwZWN0b3IgPSB0aGlzLl9tZW51SW5zcGVjdG9yUmVmLmN1cnJlbnQ7XG4gICAgICAgICAgICAgICAgaWYgKCFtZW51SW5zcGVjdG9yKSB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgICAgICAgICAgICAgICBtZW51SW5zcGVjdG9yLm1vdmVDdXJzb3IoJ2Rvd24nKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIG9uSXRlbUNob3Nlbj17KGU6IENob3NlbkV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7XG4gICAgICAgICAgICAgIGlmIChlLmJ5S2V5Ym9hcmQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtZW51SW5zcGVjdG9yID0gdGhpcy5fbWVudUluc3BlY3RvclJlZi5jdXJyZW50O1xuICAgICAgICAgICAgICAgIGlmICghbWVudUluc3BlY3RvcikgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgICAgICAgICAgICAgbWVudUluc3BlY3Rvci5tb3ZlQ3Vyc29yKCdkb3duJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH19XG4gICAgICAgICAgICBhcmlhLWhhc3BvcHVwPXt0cnVlfVxuICAgICAgICAgICAgYXJpYS1leHBhbmRlZD17b3BlbmVkfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgICA8L01lbnVJdGVtPlxuICAgICAgICB9XG4gICAgICAgIGZsb2F0PXtcbiAgICAgICAgICAhb3BlbmVkID8gbnVsbCA6XG4gICAgICAgICAgICA8TWVudUxpc3RJbnNwZWN0b3JcbiAgICAgICAgICAgICAgcmVmPXt0aGlzLl9tZW51SW5zcGVjdG9yUmVmfVxuICAgICAgICAgICAgICBvbkxlZnRQdXNoZWQ9e2UgPT4ge1xuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgPGRpdlxuICAgICAgICAgICAgICAgIHJlZj17dGhpcy5fbWVudUNvbnRhaW5lclJlZn1cbiAgICAgICAgICAgICAgICBvbk1vdXNlRW50ZXI9eygpPT50aGlzLl9tb3VzZUVudGVyTWVudSgpfVxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAge21lbnV9XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9NZW51TGlzdEluc3BlY3Rvcj5cbiAgICAgICAgfVxuICAgICAgLz5cbiAgICApO1xuICB9XG59XG4iXX0=