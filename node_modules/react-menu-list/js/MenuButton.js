"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf3 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reactFloatAnchor = _interopRequireDefault(require("react-float-anchor"));

var _kefir = _interopRequireDefault(require("kefir"));

var _kefirBus = _interopRequireDefault(require("kefir-bus"));

var _fromEventsCapture = _interopRequireDefault(require("./lib/fromEventsCapture"));

var _setRef = _interopRequireDefault(require("./lib/setRef"));

var _MenuListInspector = _interopRequireDefault(require("./MenuListInspector"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var MenuButton =
/*#__PURE__*/
function (_React$Component) {
  (0, _inherits2["default"])(MenuButton, _React$Component);

  function MenuButton() {
    var _getPrototypeOf2;

    var _this;

    (0, _classCallCheck2["default"])(this, MenuButton);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = (0, _possibleConstructorReturn2["default"])(this, (_getPrototypeOf2 = (0, _getPrototypeOf3["default"])(MenuButton)).call.apply(_getPrototypeOf2, [this].concat(args)));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      opened: false
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_floatAnchorRef", _react["default"].createRef());
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_anchorEl", null);
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_onClose", (0, _kefirBus["default"])());
    return _this;
  }

  (0, _createClass2["default"])(MenuButton, [{
    key: "open",
    value: function open() {
      var _this2 = this;

      if (this.state.opened) return Promise.resolve();
      if (this.props.onWillOpen) this.props.onWillOpen(); // Clicking outside of the dropdown or pressing escape should close the
      // dropdown.

      _kefir["default"].merge([_kefir["default"].merge([(0, _fromEventsCapture["default"])(window, 'mousedown'), (0, _fromEventsCapture["default"])(window, 'focus')]).filter(function (e) {
        var el = _this2._anchorEl;
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = _reactFloatAnchor["default"].parentNodes(e.target)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var node = _step.value;
            if (node === el) return false;
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator["return"] != null) {
              _iterator["return"]();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }

        return true;
      }), _kefir["default"].fromEvents(window, 'keydown').filter(function (e) {
        return e.key ? e.key === 'Escape' : e.which === 27;
      }).map(function (e) {
        e.preventDefault();
        e.stopPropagation();
      })]).takeUntilBy(this._onClose).onValue(function () {
        _this2.close();
      });

      return new Promise(function (resolve) {
        _this2.setState({
          opened: true
        }, function () {
          if (_this2.props.onDidOpen) _this2.props.onDidOpen();
          resolve();
        });
      });
    }
  }, {
    key: "close",
    value: function close() {
      if (!this.state.opened) return;
      if (this.props.onWillClose) this.props.onWillClose();
      this.setState({
        opened: false
      });

      this._onClose.emit();
    }
  }, {
    key: "toggle",
    value: function toggle() {
      if (this.state.opened) {
        this.close();
      } else {
        this.open();
      }
    }
  }, {
    key: "reposition",
    value: function reposition() {
      var floatAnchor = this._floatAnchorRef.current;
      if (!floatAnchor) throw new Error();
      floatAnchor.reposition();
    }
  }, {
    key: "_itemChosen",
    value: function _itemChosen() {
      this.close();
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      this._onClose.emit();
    }
  }, {
    key: "render",
    value: function render() {
      var _this3 = this;

      var _this$props = this.props,
          children = _this$props.children,
          menu = _this$props.menu,
          positionOptions = _this$props.positionOptions,
          menuZIndex = _this$props.menuZIndex,
          disabled = _this$props.disabled,
          title = _this$props.title,
          ButtonComponent = _this$props.ButtonComponent;
      var opened = this.state.opened;
      var style = this.props.style;
      var className = this.props.className;

      if (opened) {
        if (this.props.openedStyle) {
          style = _objectSpread({}, style, {}, this.props.openedStyle);
        }

        if (this.props.openedClassName) {
          className = "".concat(className || '', " ").concat(this.props.openedClassName);
        }
      }

      return _react["default"].createElement(_reactFloatAnchor["default"], {
        parentElement: this.props.menuParentElement,
        ref: this._floatAnchorRef,
        options: positionOptions,
        zIndex: menuZIndex,
        anchor: function anchor(anchorRef) {
          return _react["default"].createElement(ButtonComponent, (0, _extends2["default"])({
            domRef: function domRef(el) {
              _this3._anchorEl = el;
              (0, _setRef["default"])(anchorRef, el);
            },
            type: "button",
            className: className,
            style: style,
            onMouseDown: function onMouseDown(e) {
              if (e.button !== 0) return;

              _this3.toggle();
            },
            onKeyPress: function onKeyPress(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                _this3.toggle();
              }
            },
            "aria-haspopup": true,
            "aria-expanded": opened,
            disabled: disabled,
            title: title
          }, _this3.props.buttonProps), children);
        },
        "float": !opened ? null : _react["default"].createElement(_MenuListInspector["default"], {
          onItemChosen: function onItemChosen() {
            return _this3._itemChosen();
          }
        }, menu)
      });
    }
  }]);
  return MenuButton;
}(_react["default"].Component);

exports["default"] = MenuButton;
(0, _defineProperty2["default"])(MenuButton, "propTypes", {
  className: _propTypes["default"].string,
  style: _propTypes["default"].object,
  disabled: _propTypes["default"].bool,
  title: _propTypes["default"].string,
  openedClassName: _propTypes["default"].string,
  openedStyle: _propTypes["default"].object,
  positionOptions: _propTypes["default"].object,
  menuZIndex: _propTypes["default"].oneOfType([_propTypes["default"].string, _propTypes["default"].number]),
  ButtonComponent: _propTypes["default"].func,
  buttonProps: _propTypes["default"].object,
  children: _propTypes["default"].node,
  menu: _propTypes["default"].element,
  onWillOpen: _propTypes["default"].func,
  onDidOpen: _propTypes["default"].func,
  onWillClose: _propTypes["default"].func
});
(0, _defineProperty2["default"])(MenuButton, "defaultProps", {
  positionOptions: {
    position: 'bottom',
    hAlign: 'left'
  },
  ButtonComponent: function ButtonComponent(_ref) {
    var domRef = _ref.domRef,
        props = (0, _objectWithoutProperties2["default"])(_ref, ["domRef"]);
    return _react["default"].createElement("button", (0, _extends2["default"])({
      ref: domRef
    }, props));
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZW51QnV0dG9uLmpzIl0sIm5hbWVzIjpbIk1lbnVCdXR0b24iLCJvcGVuZWQiLCJSZWFjdCIsImNyZWF0ZVJlZiIsInN0YXRlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJwcm9wcyIsIm9uV2lsbE9wZW4iLCJLZWZpciIsIm1lcmdlIiwid2luZG93IiwiZmlsdGVyIiwiZSIsImVsIiwiX2FuY2hvckVsIiwiRmxvYXRBbmNob3IiLCJwYXJlbnROb2RlcyIsInRhcmdldCIsIm5vZGUiLCJmcm9tRXZlbnRzIiwia2V5Iiwid2hpY2giLCJtYXAiLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsInRha2VVbnRpbEJ5IiwiX29uQ2xvc2UiLCJvblZhbHVlIiwiY2xvc2UiLCJzZXRTdGF0ZSIsIm9uRGlkT3BlbiIsIm9uV2lsbENsb3NlIiwiZW1pdCIsIm9wZW4iLCJmbG9hdEFuY2hvciIsIl9mbG9hdEFuY2hvclJlZiIsImN1cnJlbnQiLCJFcnJvciIsInJlcG9zaXRpb24iLCJjaGlsZHJlbiIsIm1lbnUiLCJwb3NpdGlvbk9wdGlvbnMiLCJtZW51WkluZGV4IiwiZGlzYWJsZWQiLCJ0aXRsZSIsIkJ1dHRvbkNvbXBvbmVudCIsInN0eWxlIiwiY2xhc3NOYW1lIiwib3BlbmVkU3R5bGUiLCJvcGVuZWRDbGFzc05hbWUiLCJtZW51UGFyZW50RWxlbWVudCIsImFuY2hvclJlZiIsImJ1dHRvbiIsInRvZ2dsZSIsImJ1dHRvblByb3BzIiwiX2l0ZW1DaG9zZW4iLCJDb21wb25lbnQiLCJQcm9wVHlwZXMiLCJzdHJpbmciLCJvYmplY3QiLCJib29sIiwib25lT2ZUeXBlIiwibnVtYmVyIiwiZnVuYyIsImVsZW1lbnQiLCJwb3NpdGlvbiIsImhBbGlnbiIsImRvbVJlZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7OztJQTBC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VUcsSUFISDtBQUlqQmhCLEVBQUFBLEtBQUssRUFBRWEsc0JBQVVDLE1BSkE7QUFLakJULEVBQUFBLGVBQWUsRUFBRVEsc0JBQVVDLE1BTFY7QUFNakJWLEVBQUFBLFdBQVcsRUFBRVMsc0JBQVVFLE1BTk47QUFRakJsQixFQUFBQSxlQUFlLEVBQUVnQixzQkFBVUUsTUFSVjtBQVNqQmpCLEVBQUFBLFVBQVUsRUFBRWUsc0JBQVVJLFNBQVYsQ0FBb0IsQ0FBQ0osc0JBQVVDLE1BQVgsRUFBbUJELHNCQUFVSyxNQUE3QixDQUFwQixDQVRLO0FBVWpCakIsRUFBQUEsZUFBZSxFQUFFWSxzQkFBVU0sSUFWVjtBQVdqQlQsRUFBQUEsV0FBVyxFQUFFRyxzQkFBVUUsTUFYTjtBQWFqQnBCLEVBQUFBLFFBQVEsRUFBRWtCLHNCQUFVdkMsSUFiSDtBQWNqQnNCLEVBQUFBLElBQUksRUFBRWlCLHNCQUFVTyxPQWRDO0FBZWpCekQsRUFBQUEsVUFBVSxFQUFFa0Qsc0JBQVVNLElBZkw7QUFnQmpCakMsRUFBQUEsU0FBUyxFQUFFMkIsc0JBQVVNLElBaEJKO0FBaUJqQmhDLEVBQUFBLFdBQVcsRUFBRTBCLHNCQUFVTTtBQWpCTixDO2lDQURBaEUsVSxrQkFxQkc7QUFDcEIwQyxFQUFBQSxlQUFlLEVBQUU7QUFBQ3dCLElBQUFBLFFBQVEsRUFBQyxRQUFWO0FBQW9CQyxJQUFBQSxNQUFNLEVBQUM7QUFBM0IsR0FERztBQUVwQnJCLEVBQUFBLGVBQWUsRUFBRTtBQUFBLFFBQUVzQixNQUFGLFFBQUVBLE1BQUY7QUFBQSxRQUFhN0QsS0FBYjtBQUFBLFdBQWdDO0FBQVEsTUFBQSxHQUFHLEVBQUU2RDtBQUFiLE9BQXlCN0QsS0FBekIsRUFBaEM7QUFBQTtBQUZHLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHR5cGUge1JlZiBhcyBSZWFjdFJlZiwgTm9kZSBhcyBSZWFjdE5vZGUsIENvbXBvbmVudFR5cGUgYXMgUmVhY3RDb21wb25lbnRUeXBlfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IEZsb2F0QW5jaG9yIGZyb20gJ3JlYWN0LWZsb2F0LWFuY2hvcic7XG5pbXBvcnQgdHlwZSB7T3B0aW9ucyBhcyBGbG9hdEFuY2hvck9wdGlvbnN9IGZyb20gJ3JlYWN0LWZsb2F0LWFuY2hvcic7XG5pbXBvcnQgS2VmaXIgZnJvbSAna2VmaXInO1xuaW1wb3J0IGtlZmlyQnVzIGZyb20gJ2tlZmlyLWJ1cyc7XG5pbXBvcnQgdHlwZSB7QnVzfSBmcm9tICdrZWZpci1idXMnO1xuaW1wb3J0IGZyb21FdmVudHNDYXB0dXJlIGZyb20gJy4vbGliL2Zyb21FdmVudHNDYXB0dXJlJztcbmltcG9ydCBzZXRSZWYgZnJvbSAnLi9saWIvc2V0UmVmJztcbmltcG9ydCBNZW51TGlzdEluc3BlY3RvciBmcm9tICcuL01lbnVMaXN0SW5zcGVjdG9yJztcblxudHlwZSBTdGF0ZSA9IHtcbiAgb3BlbmVkOiBib29sZWFuO1xufTtcbmV4cG9ydCB0eXBlIFByb3BzID0ge1xuICBjbGFzc05hbWU/OiBzdHJpbmc7XG4gIHN0eWxlPzogT2JqZWN0O1xuICBkaXNhYmxlZD86IGJvb2xlYW47XG4gIHRpdGxlPzogc3RyaW5nO1xuICBvcGVuZWRDbGFzc05hbWU/OiBzdHJpbmc7XG4gIG9wZW5lZFN0eWxlPzogT2JqZWN0O1xuXG4gIHBvc2l0aW9uT3B0aW9uczogRmxvYXRBbmNob3JPcHRpb25zO1xuICBtZW51WkluZGV4Pzogc3RyaW5nfG51bWJlcjtcbiAgbWVudVBhcmVudEVsZW1lbnQ/OiBIVE1MRWxlbWVudDtcbiAgQnV0dG9uQ29tcG9uZW50OiBSZWFjdENvbXBvbmVudFR5cGU8e2RvbVJlZjogUmVhY3RSZWY8YW55Pn0+O1xuICBidXR0b25Qcm9wcz86IE9iamVjdDtcblxuICBjaGlsZHJlbj86IFJlYWN0Tm9kZTtcbiAgbWVudTogUmVhY3ROb2RlO1xuICBvbldpbGxPcGVuPzogKCkgPT4gdm9pZDtcbiAgb25EaWRPcGVuPzogKCkgPT4gdm9pZDtcbiAgb25XaWxsQ2xvc2U/OiAoKSA9PiB2b2lkO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWVudUJ1dHRvbiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxQcm9wcywgU3RhdGU+IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgc3R5bGU6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgZGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLFxuICAgIHRpdGxlOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIG9wZW5lZENsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBvcGVuZWRTdHlsZTogUHJvcFR5cGVzLm9iamVjdCxcblxuICAgIHBvc2l0aW9uT3B0aW9uczogUHJvcFR5cGVzLm9iamVjdCxcbiAgICBtZW51WkluZGV4OiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMubnVtYmVyXSksXG4gICAgQnV0dG9uQ29tcG9uZW50OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBidXR0b25Qcm9wczogUHJvcFR5cGVzLm9iamVjdCxcblxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMubm9kZSxcbiAgICBtZW51OiBQcm9wVHlwZXMuZWxlbWVudCxcbiAgICBvbldpbGxPcGVuOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBvbkRpZE9wZW46IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uV2lsbENsb3NlOiBQcm9wVHlwZXMuZnVuY1xuICB9O1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgcG9zaXRpb25PcHRpb25zOiB7cG9zaXRpb246J2JvdHRvbScsIGhBbGlnbjonbGVmdCd9LFxuICAgIEJ1dHRvbkNvbXBvbmVudDogKHtkb21SZWYsIC4uLnByb3BzfTogT2JqZWN0KSA9PiA8YnV0dG9uIHJlZj17ZG9tUmVmfSB7Li4ucHJvcHN9IC8+XG4gIH07XG5cbiAgc3RhdGU6IFN0YXRlID0ge1xuICAgIG9wZW5lZDogZmFsc2VcbiAgfTtcblxuICBfZmxvYXRBbmNob3JSZWYgPSBSZWFjdC5jcmVhdGVSZWY8RmxvYXRBbmNob3I+KCk7XG4gIF9hbmNob3JFbDogP0hUTUxFbGVtZW50ID0gbnVsbDtcbiAgX29uQ2xvc2U6IEJ1czx2b2lkPiA9IGtlZmlyQnVzKCk7XG5cbiAgb3BlbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5zdGF0ZS5vcGVuZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICBpZiAodGhpcy5wcm9wcy5vbldpbGxPcGVuKSB0aGlzLnByb3BzLm9uV2lsbE9wZW4oKTtcblxuICAgIC8vIENsaWNraW5nIG91dHNpZGUgb2YgdGhlIGRyb3Bkb3duIG9yIHByZXNzaW5nIGVzY2FwZSBzaG91bGQgY2xvc2UgdGhlXG4gICAgLy8gZHJvcGRvd24uXG4gICAgS2VmaXIubWVyZ2UoW1xuICAgICAgS2VmaXIubWVyZ2UoW1xuICAgICAgICBmcm9tRXZlbnRzQ2FwdHVyZSh3aW5kb3csICdtb3VzZWRvd24nKSxcbiAgICAgICAgZnJvbUV2ZW50c0NhcHR1cmUod2luZG93LCAnZm9jdXMnKVxuICAgICAgXSlcbiAgICAgICAgLmZpbHRlcihlID0+IHtcbiAgICAgICAgICBjb25zdCBlbCA9IHRoaXMuX2FuY2hvckVsO1xuICAgICAgICAgIGZvciAobGV0IG5vZGUgb2YgRmxvYXRBbmNob3IucGFyZW50Tm9kZXMoZS50YXJnZXQpKSB7XG4gICAgICAgICAgICBpZiAobm9kZSA9PT0gZWwpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pLFxuICAgICAgS2VmaXIuZnJvbUV2ZW50cyh3aW5kb3csICdrZXlkb3duJylcbiAgICAgICAgLmZpbHRlcihlID0+IGUua2V5ID8gZS5rZXkgPT09ICdFc2NhcGUnIDogZS53aGljaCA9PT0gMjcpXG4gICAgICAgIC5tYXAoZSA9PiB7XG4gICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIH0pXG4gICAgXSlcbiAgICAgIC50YWtlVW50aWxCeSh0aGlzLl9vbkNsb3NlKVxuICAgICAgLm9uVmFsdWUoKCkgPT4ge1xuICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICB9KTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe29wZW5lZDogdHJ1ZX0sICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25EaWRPcGVuKSB0aGlzLnByb3BzLm9uRGlkT3BlbigpO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGNsb3NlKCkge1xuICAgIGlmICghdGhpcy5zdGF0ZS5vcGVuZWQpIHJldHVybjtcbiAgICBpZiAodGhpcy5wcm9wcy5vbldpbGxDbG9zZSkgdGhpcy5wcm9wcy5vbldpbGxDbG9zZSgpO1xuICAgIHRoaXMuc2V0U3RhdGUoe29wZW5lZDogZmFsc2V9KTtcbiAgICB0aGlzLl9vbkNsb3NlLmVtaXQoKTtcbiAgfVxuXG4gIHRvZ2dsZSgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS5vcGVuZWQpIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5vcGVuKCk7XG4gICAgfVxuICB9XG5cbiAgcmVwb3NpdGlvbigpIHtcbiAgICBjb25zdCBmbG9hdEFuY2hvciA9IHRoaXMuX2Zsb2F0QW5jaG9yUmVmLmN1cnJlbnQ7XG4gICAgaWYgKCFmbG9hdEFuY2hvcikgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgZmxvYXRBbmNob3IucmVwb3NpdGlvbigpO1xuICB9XG5cbiAgX2l0ZW1DaG9zZW4oKSB7XG4gICAgdGhpcy5jbG9zZSgpO1xuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5fb25DbG9zZS5lbWl0KCk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgY2hpbGRyZW4sIG1lbnUsXG4gICAgICBwb3NpdGlvbk9wdGlvbnMsIG1lbnVaSW5kZXgsXG4gICAgICBkaXNhYmxlZCwgdGl0bGUsIEJ1dHRvbkNvbXBvbmVudFxuICAgIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHtvcGVuZWR9ID0gdGhpcy5zdGF0ZTtcblxuICAgIGxldCBzdHlsZSA9IHRoaXMucHJvcHMuc3R5bGU7XG4gICAgbGV0IGNsYXNzTmFtZSA9IHRoaXMucHJvcHMuY2xhc3NOYW1lO1xuICAgIGlmIChvcGVuZWQpIHtcbiAgICAgIGlmICh0aGlzLnByb3BzLm9wZW5lZFN0eWxlKSB7XG4gICAgICAgIHN0eWxlID0gey4uLnN0eWxlLCAuLi50aGlzLnByb3BzLm9wZW5lZFN0eWxlfTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnByb3BzLm9wZW5lZENsYXNzTmFtZSkge1xuICAgICAgICBjbGFzc05hbWUgPSBgJHtjbGFzc05hbWV8fCcnfSAke3RoaXMucHJvcHMub3BlbmVkQ2xhc3NOYW1lfWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxGbG9hdEFuY2hvclxuICAgICAgICBwYXJlbnRFbGVtZW50PXt0aGlzLnByb3BzLm1lbnVQYXJlbnRFbGVtZW50fVxuICAgICAgICByZWY9e3RoaXMuX2Zsb2F0QW5jaG9yUmVmfVxuICAgICAgICBvcHRpb25zPXtwb3NpdGlvbk9wdGlvbnN9XG4gICAgICAgIHpJbmRleD17bWVudVpJbmRleH1cbiAgICAgICAgYW5jaG9yPXthbmNob3JSZWYgPT5cbiAgICAgICAgICA8QnV0dG9uQ29tcG9uZW50XG4gICAgICAgICAgICBkb21SZWY9e2VsID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5fYW5jaG9yRWwgPSBlbDtcbiAgICAgICAgICAgICAgc2V0UmVmKGFuY2hvclJlZiwgZWwpO1xuICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWV9XG4gICAgICAgICAgICBzdHlsZT17c3R5bGV9XG4gICAgICAgICAgICBvbk1vdXNlRG93bj17ZSA9PiB7XG4gICAgICAgICAgICAgIGlmIChlLmJ1dHRvbiAhPT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICB0aGlzLnRvZ2dsZSgpO1xuICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIG9uS2V5UHJlc3M9e2U9PntcbiAgICAgICAgICAgICAgaWYgKGUua2V5ID09PSAnRW50ZXInIHx8IGUua2V5ID09PSAnICcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9fVxuICAgICAgICAgICAgYXJpYS1oYXNwb3B1cD17dHJ1ZX1cbiAgICAgICAgICAgIGFyaWEtZXhwYW5kZWQ9e29wZW5lZH1cbiAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlZH1cbiAgICAgICAgICAgIHRpdGxlPXt0aXRsZX1cbiAgICAgICAgICAgIHsuLi50aGlzLnByb3BzLmJ1dHRvblByb3BzfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgICA8L0J1dHRvbkNvbXBvbmVudD5cbiAgICAgICAgfVxuICAgICAgICBmbG9hdD17XG4gICAgICAgICAgIW9wZW5lZCA/IG51bGwgOlxuICAgICAgICAgICAgPE1lbnVMaXN0SW5zcGVjdG9yIG9uSXRlbUNob3Nlbj17KCkgPT4gdGhpcy5faXRlbUNob3NlbigpfT5cbiAgICAgICAgICAgICAge21lbnV9XG4gICAgICAgICAgICA8L01lbnVMaXN0SW5zcGVjdG9yPlxuICAgICAgICB9XG4gICAgICAvPlxuICAgICk7XG4gIH1cbn1cbiJdfQ==